#!/usr/bin/perl

use strict;

my ($sourceSite, $projectsFile) = @ARGV;


usage() unless $sourceSite && $projectsFile;


my @projects;
if ($projectsFile) {
  open(F, $projectsFile) || die "Can't open projectsFile '$projectsFile'\n";
  while (<F>) {
    my ($abbrev, $project) = split(/\s/);
    die "In projects_file '$projectsFile' abbrev '$abbrev' is not valid.  It should be four letters\n" unless $abbrev =~ /\w\w\w\w/;
    die "In projects_file '$projectsFile' project '$project' is not valid.  It should end in DB\n" unless $project =~ /DB$/;
    push(@projects, $project);
  }
  close(F);
}

foreach my $project (@projects) {
  next if grep(/$project/, ("OrthoMCLDB", "MicrobiomeDB"));
  my $cmd = "jenkinsJobScmUpdate $sourceSite maint.$project.org";
  print STDERR "running cmd: $cmd\n";
  system($cmd) && die "Failed running command '$cmd'\n";
}

sub usage {
  die "

Call jenkinsJobScmUpdate for a list of projects

Usage: jenkinsJobScmUpdateMulti source_site projects_file

Where:
  source_site:  the site to copy from, eg q1.plasmodb.org
  projects_file: a tab delimited file.  first column is four letter abbrev of project, eg, plas, (ignored).  second column is project name, eg PlasmoDB
";
}

