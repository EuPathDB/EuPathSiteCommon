#!/usr/bin/perl

use strict;

my ($metaFile, $instanceSuffix) = @ARGV;

my @components = (
 ['ameb', 'AmoebaDB'],
 ['cryp', 'CryptoDB'],
 ['eupa', 'EuPathDB'],
 ['fung', 'FungiDB'],
 ['giar', 'GiardiaDB'],
 ['host', 'HostDB'],
 ['mbio', 'MicrobiomeDB'],
 ['micr', 'MicrosporidiaDB'],
 ['piro', 'PiroplasmaDB'],
 ['plas', 'PlasmoDB'],
 ['schi', 'SchistoDB'],
 ['toxo', 'ToxoDB'],
 ['tryp', 'TriTrypDB'],
 ['tvag', 'TrichDB'],
);

my @c = map {join("\t", @$_)} @components;
my $componentsString = join("\n", @c);

usage() unless $metaFile;

my $masterProject;
my $masterProjectLower;
my $masterPrefix;
if ($metaFile =~ /(\w+)MetaConfig.yaml/) {
  $masterProject = $1;
  $masterProjectLower = lc($masterProject);
  my $found;
  foreach my $c (@components) { if ($c->[1] eq $masterProject) { $found = 1; $masterPrefix = $c->[0]; last }}
  die "\nmeta file '$metaFile' project '$masterProject' is not known.  These are the known components:\n\n$componentsString\n" unless $found;
} else {
  die "\nmeta file '$metaFile' must be of the form xxxxxMetaConfig.yaml\n" unless $metaFile =~ /(\w+)MetaConfig.yaml/;
}

open(F, $metaFile) || die "Can't open meta file '$metaFile'\n";
my @metaFileLines = <F>;
close(F);

my %instanceSuffixes;
if (!$instanceSuffix) {
  print STDERR "Reading instance info from STDIN...\n";
  while(<STDIN>) {
    if (/(\w\w\w\w)-(inc|rbld)/) {
      my $prefix = $1;
      my $suffix = $2;
      die "Prefix '$prefix' is has both -inc and -rbld in STDIN.  Please remove one (eg, use grep -v).\n" if $instanceSuffixes{$prefix};
      $instanceSuffixes{$prefix} = "-$suffix" ;
    }
  }
}
close(S);

my $projectLineIndex;
my $appDbLineIndex;
my $projectSectionLineIndex;
my $index = 0;
foreach my $line (@metaFileLines) {
  $projectLineIndex = $index if $line =~ /project\:/;
  $projectSectionLineIndex = $index if $line =~ / - $masterProjectLower/;
  if ($line =~ /appDb.instance\:\s*(\S+)/) {
    my $instanceNm = $1;
    $appDbLineIndex = $index;
    my $expectedSuffix = $instanceSuffix;
    $expectedSuffix = $instanceSuffixes{$masterPrefix} unless $expectedSuffix;
    die "Please set ${metaFile}'s appDb.instance to $masterPrefix$expectedSuffix\n" unless $instanceNm =~ /$expectedSuffix/;
  }
  $index++;
}

die "Can't find 'project:' or 'appDb.instance:' lines in provided meta file\n" unless $projectLineIndex && $appDbLineIndex;

# print "Indexes: $projectLineIndex, $appDbLineIndex, $projectSectionLineIndex\n";
# print "Masters: $masterProject, $masterProjectLower\n";
foreach my $component (@components) {
  my $prefix = $component->[0];
  next if $prefix eq $masterPrefix;
  my $project = $component->[1];
  my $projectLower = lc($project);
  my $file = "${project}MetaConfig.yaml";
  print "Generating $file...\n";
  open(C, ">$file") || die "Can't open '$file' for output\n";
  my $i = 0;
  my $suffix = $instanceSuffix;
  $suffix = $instanceSuffixes{$prefix} unless $suffix;
  die "Couldn't find a line for '$prefix' in apiTnsSummary\n" unless $suffix;
  my $instance = "${prefix}$suffix";
  foreach my $line (@metaFileLines) {
    $line =~ s/project: \S+/project: $project/ if $i == $projectLineIndex;
    $line =~ s/appDb.instance: \S+/appDb.instance: $instance/ if $i == $appDbLineIndex;
    $line =~ s/ - \S+/ - $projectLower/ if $i == $projectSectionLineIndex;
    $i++;
    print C $line;
  }
  close(C);
}

sub usage {

  die "

Generate a set of metaConfig.yaml files from a provided example meta file.  Each output file is for one component
website, eg, ToxoDB, CryptoDB, etc.

Usage: eupathCloneMetaFile meta_file [instance_suffix]

Where:
  meta_file:         the file to copy from.  Must be of the form xxxxxMetaConfig.yaml, where xxxxx is a known
                     component project name(see below).
  instance_suffix:   optional.  If provided, use this suffix to construct the appDb.instance name.
                     Eg, provide 029n to get instances like toxo029n, cryp029n, etc.   If not provided, use
                     either -inc or -rbld, whichever is present in apiTnsSummary for this component

Example command lines:

  eupathCloneMetaFile PlasmoDBMetaFile.yaml 029n

  apiTnsSummary | eupathCloneMetaFile PlasmoDBMetaFile.yaml


Input:  unless instance_suffix is provided, STDIN is a stream of lines that contain instance names like plas-inc.  The output of
        apiTnsSummary is the typical input.  the relevant instance names are discovered by the pattern /(\w\w\w\w)-(inc|rbld)/.

Output: a set of files in the current directory of the form xxxxxMetaConfig.yaml, where xxxx is the project name.

The output files are identical to the provided meta file, except these lines:
 project: PlasmoDB
 appDb.instance: plas-inc
 - plasmodb

The components currently supported are the following (update the script file to change this):

$componentsString

";
}
