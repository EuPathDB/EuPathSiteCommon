#!/usr/bin/perl

use strict;

usage() unless scalar(@ARGV);

my ($argsMap, $argsArr) = &extractArgs(@ARGV);

die "Error: Can't use eupathUserDbMigrationMulti without arguments: --primaryModel and --project\n" unless $argsMap->{'--project'} && $argsMap->{'--primaryModel'};

my @projects = split(/,\s*/, $argsMap->{'--project'});

die "Error: No projects supplied" unless scalar(@projects);

my $controlDir = $argsMap->{'--controlDir'};

die "Control dir '$controlDir' does not exist\n" unless (-d $controlDir);

my $logFile = "$controlDir/multi.log";
open(LOG, ">>$logFile") || die "Can't open log file '$logFile'\n";
print LOG "===========================================================================\n\n";
print LOG localtime . "\tRunning cmd: eupathUserDbMigrationMulti " . join(" ", @ARGV) . "\n\n";


# do init phase
doPhase($argsMap, $argsArr, "init");

# do each project
my $failedCount = 0;
foreach my $project (@projects) {
  next if ($argsMap->{'--usingSandbox'} && $project eq 'EuPathDB');
  my %newArgsMap = %$argsMap;
  $newArgsMap{'--project'} = $project;
  $newArgsMap{'--primaryModel'} = $project if $newArgsMap{'--primaryModel'};
  $newArgsMap{'--controlDir'} .= "/$project";
  if (! -d $newArgsMap{'--controlDir'} && !mkdir $newArgsMap{'--controlDir'}) {
    log("Could not create controlDir '$newArgsMap{'--controlDir'}'.  Skipping this project");
    next;
  }
  my $status = runPipeline(\%newArgsMap, $argsArr);
  $failedCount++ if $status;
  &log($project . ($status? " Failed\n" : " Succeeded\n"));
}

# do clean phase
if ($failedCount) {
  &log("$failedCount projects failed.  Skipping clean phase.");
} else {
  doPhase($argsMap, $argsArr, "clean");
  &log("Done. No projects failed.");
}




###################################################################################################

sub doPhase {
  my ($argsMap, $argsArr, $phase) = @_;
  my %newArgsMap = %$argsMap;
  $newArgsMap{'--project'} = $argsMap->{'--primaryModel'};
  $newArgsMap{'--controlDir'} .= "/$phase";
  $newArgsMap{'--phase'} = $phase;
  if (! -d $newArgsMap{'--controlDir'} && !mkdir $newArgsMap{'--controlDir'}) {
    die("Could not create controlDir '$newArgsMap{'--controlDir'}'.\n");
  }
  runPipeline(\%newArgsMap, $argsArr)
    && die "Failed running $phase phase.\n";
}


sub runPipeline {
  my ($argsMap, $argsArr) = @_;

 # my @cmdLineArgs = map { ($_, $argsMap->{$_}) } @$argsArr;
  my @cmdLineArgs = map { ($_, $argsMap->{$_}) } keys(%$argsMap);
  my $cmd = "eupathUserDbMigration " . join (" ", @cmdLineArgs) . " 2> $argsMap->{'--controlDir'}/pipeline.err";
  &log($cmd);
  my $status = system($cmd);
  return $status;
}

sub log {
  my ($msg) = @_;
  print LOG localtime . "\t$msg\n\n";
}

sub extractArgs {
  my @args = @_;
  my %map;
  my @arr;
  my $prevArg;
  foreach my $arg (@args) {
    if (substr($arg,0,2) eq '--') {
      $map{$arg} = "";
      $prevArg = $arg;
      push(@arr, $arg);
    } else {
      $map{$prevArg} = $arg;
    }
  }
  return (\%map, \@arr);
}

sub usage {

die "
Run a set of user db migration pipelines (serially), one per project.  Set things up by running a single pipeline, in  init phase, using the primary model as the model.  Finalize by running a single pipeline, in the clean phase, using the primary model as the model.  Only run clean if all project pipelines succeeed.

Usage: eupathUserDbMigrationMulti cmd_line_args

Where: 
  cmd_line_args:  the exact arguments you want passed to each parallel run of eupathUserDbMigration.

The --primaryProject argument is used as the project for the init and clean phases.

The --project argument is used to drive the parallel runs.  Each project P specified in that list is given its own run.  In those separate runs:
  - the --project argument is set to a single project, P.
  - the --primaryModel argument is set to P
  - the --controlDir argument is appended with /P, to give each run a private control dir named after its project

The set of commands executed by eupathUserDbMigrationMulti are listed in controlDir/multi.log

The standard error of each run of eupathUserDbMigration is in pipeline.err, in the project's control dir.
";

}
